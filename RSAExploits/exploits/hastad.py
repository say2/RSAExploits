#!/usr/bin/env python

from RSAExploits import util
from Exploit import Exploit

class hastad(Exploit):
	
	def run(self, rsadata):
		print ("Hastad: Running Attack...")
		success = False		
		edict = self.group_by_e(rsadata)
		for e, nc in edict.iteritems():
			n, c = nc[::2], nc[1::2]
			msg = self.execute(e, n, c)
			if msg != None:
				success = True 
				for rdata in rsadata:
					if e == rdata.getE():
						rdata.setM(msg)			    
		if success:
			print("Hastad: Success, message found.")							
		else: 			
			print("Hastad: Failure, message not found.")
		return success
			
	@staticmethod 		
	def group_by_e(dset):
		edict = {}
		for rdata in dset:
			if rdata.getE() in edict:
				if rdata.getN() not in edict[rdata.getE()]:
					edict[rdata.rsaobj.e].append(rdata.getN())
					edict[rdata.rsaobj.e].append(rdata.getC())	
			else:
				edict.update({rdata.rsaobj.e:[rdata.getN()]})
				edict[rdata.rsaobj.e].append(rdata.getC())	
		return edict
	

	@staticmethod
	def execute(e,ns,cs):
		s = util.CRT(ns, cs)
		pt = util.int_nthroot(s, e)
		if pt is not None:
			return pt
		else:
		#	print "Cannot find %dth root of %s" % (e, hex(s))
			return None

		    
