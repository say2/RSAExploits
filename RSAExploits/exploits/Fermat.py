#!/usr/bin/env python

from sympy import integer_nthroot
from RSAExploits.exploits.Exploit import Exploit
from RSAExploits.util import compute_priv_rsa_exp

class Fermat(Exploit):
	def run(self, rsadata_list):
		print ("Fermat: Running Attack...")
		success = False
		for rsadata in rsadata_list:
			roots = Fermat.fermat_factor(rsadata.get_n())
			
			if roots != None:
				rsadata.set_d(compute_priv_rsa_exp(rsadata.get_e(), roots))
				success = True
		
		if success:		
			print("Fermat: Success, roots found, assigned in rsadata.")
			return True							
		else: 			
			print("Fermat: Failure, roots not found.")
			return False
	
	
	@staticmethod	
	def fermat_factor(n):
		limit = 1000000000
		a, exact = integer_nthroot(n, 2)
		_max = a + limit
		while a < _max:
			b2 = a*a - n
			if b2 >= 0:
				b, exact = integer_nthroot(b2, 2)
				if b != None:
					if b*b == b2:
						break
			a += 1
		if a < _max:
			p = a+b
			q = a-b
			return p, q
		else:
			return None

        


